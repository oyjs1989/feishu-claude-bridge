# 接口设计文档

## 1. WebSocketManager 接口

### connect()
```javascript
/**
 * 建立 WebSocket 连接
 * @returns {Promise<void>}
 */
connect(): Promise<void>
```

### disconnect()
```javascript
/**
 * 断开 WebSocket 连接
 * @returns {Promise<void>}
 */
disconnect(): Promise<void>
```

### on(event, callback)
```javascript
/**
 * 注册事件监听器
 * @param {string} event - 事件名称
 * @param {Function} callback - 回调函数
 */
on(event: string, callback: Function): void
```

### send(data)
```javascript
/**
 * 发送数据到飞书
 * @param {Object} data - 要发送的数据
 * @returns {Promise<void>}
 */
send(data: Object): Promise<void>
```

---

## 2. EventHandler 接口

### handle(event)
```javascript
/**
 * 处理飞书事件
 * @param {Object} event - 飞书事件对象
 * @returns {Promise<Object>}
 */
handle(event: Object): Promise<Object>
```

### parseMessage(event)
```javascript
/**
 * 解析消息内容
 * @param {Object} event - 飞书事件对象
 * @returns {string} - 消息内容
 */
parseMessage(event: Object): string
```

### extractUserInfo(event)
```javascript
/**
 * 提取用户信息
 * @param {Object} event - 飞书事件对象
 * @returns {Object} - 用户信息
 */
extractUserInfo(event: Object): {
  userId: string,
  userName: string,
  openId: string
}
```

---

## 3. MessageRouter 接口

### route(message, userInfo)
```javascript
/**
 * 路由消息
 * @param {string} message - 消息内容
 * @param {Object} userInfo - 用户信息
 * @returns {Promise<void>}
 */
route(message: string, userInfo: Object): Promise<void>
```

### handleNewSession(message, userInfo)
```javascript
/**
 * 处理新会话
 * @param {string} message - 消息内容
 * @param {Object} userInfo - 用户信息
 * @returns {Promise<void>}
 */
handleNewSession(message: string, userInfo: Object): Promise<void>
```

### handleExistingSession(message, userInfo)
```javascript
/**
 * 处理已有会话
 * @param {string} message - 消息内容
 * @param {Object} userInfo - 用户信息
 * @returns {Promise<void>}
 */
handleExistingSession(message: string, userInfo: Object): Promise<void>
```

---

## 4. IFlowAdapter 接口

### execute(command, options)
```javascript
/**
 * 执行 iFlow 命令
 * @param {string} command - 要执行的命令
 * @param {Object} options - 执行选项
 * @returns {Promise<Object>}
 */
execute(command: string, options: {
  yoloMode?: boolean,
  autoConfirm?: boolean,
  timeout?: number,
  superpowersEnabled?: boolean,
  superpowersMode?: string
}): Promise<{
  success: boolean,
  output: string,
  error?: string,
  nextPhase?: string
}>
```

### executeWithSuperpowers(command, options)
```javascript
/**
 * 通过 superpowers 执行命令
 * @param {string} command - 要执行的命令
 * @param {Object} options - 执行选项
 * @returns {Promise<Object>}
 */
executeWithSuperpowers(command: string, options: Object): Promise<Object>
```

### parseOutput(output)
```javascript
/**
 * 解析执行输出
 * @param {string} output - 执行输出
 * @returns {Object}
 */
parseOutput(output: string): {
  success: boolean,
  nextPhase?: string,
  error?: string
}
```

### extractNextPhase(output)
```javascript
/**
 * 提取 NEXT_PHASE
 * @param {string} output - 执行输出
 * @returns {string | null}
 */
extractNextPhase(output: string): string | null
```

---

## 5. ResultAnalyzer 接口

### analyze(output)
```javascript
/**
 * 分析执行结果
 * @param {string} output - 执行输出
 * @returns {Object}
 */
analyze(output: string): {
  status: 'continue' | 'complete' | 'error',
  nextPhase: string | null,
  summary: string,
  error: string | null
}
```

### extractNextPhase(output)
```javascript
/**
 * 提取下一阶段目标
 * @param {string} output - 执行输出
 * @returns {string | null}
 */
extractNextPhase(output: string): string | null
```

### generateSummary(output, session)
```javascript
/**
 * 生成执行摘要
 * @param {string} output - 执行输出
 * @param {Object} session - 会话信息
 * @returns {string}
 */
generateSummary(output: string, session: Object): string
```

### shouldContinue(output)
```javascript
/**
 * 判断是否应该继续
 * @param {string} output - 执行输出
 * @returns {boolean}
 */
shouldContinue(output: string): boolean
```

---

## 6. SessionManager 接口

### createSession(userInfo)
```javascript
/**
 * 创建新会话
 * @param {Object} userInfo - 用户信息
 * @returns {Object}
 */
createSession(userInfo: {
  userId: string,
  userName: string,
  openId: string
}): {
  sessionId: string,
  userId: string,
  userName: string,
  createdAt: Date,
  status: 'idle' | 'running' | 'completed' | 'error',
  loopCount: 0,
  history: Array
}
```

### getSession(sessionId)
```javascript
/**
 * 获取会话
 * @param {string} sessionId - 会话ID
 * @returns {Object | null}
 */
getSession(sessionId: string): Object | null
```

### updateSession(sessionId, data)
```javascript
/**
 * 更新会话
 * @param {string} sessionId - 会话ID
 * @param {Object} data - 更新数据
 * @returns {Promise<void>}
 */
updateSession(sessionId: string, data: Object): Promise<void>
```

### saveSession(sessionId)
```javascript
/**
 * 保存会话到 .md 文件
 * @param {string} sessionId - 会话ID
 * @returns {Promise<void>}
 */
saveSession(sessionId: string): Promise<void>
```

### loadSession(sessionId)
```javascript/**
 * 从 .md 文件加载会话
 * @param {string} sessionId - 会话ID
 * @returns {Promise<Object | null>}
 */
loadSession(sessionId: string): Promise<Object | null>
```

### deleteSession(sessionId)
```javascript
/**
 * 删除会话
 * @param {string} sessionId - 会话ID
 * @returns {Promise<void>}
 */
deleteSession(sessionId: string): Promise<void>
```

---

## 7. ProgressManager 接口

### start(sessionId)
```javascript
/**
 * 启动进度监控
 * @param {string} sessionId - 会话ID
 */
start(sessionId: string): void
```

### stop(sessionId)
```javascript
/**
 * 停止进度监控
 * @param {string} sessionId - 会话ID
 */
stop(sessionId: string): void
```

### generateProgress(session)
```javascript
/**
 * 生成进度摘要
 * @param {Object} session - 会话信息
 * @returns {string}
 */
generateProgress(session: Object): string
```

### sendProgress(sessionId, summary)
```javascript
/**
 * 发送进度到飞书
 * @param {string} sessionId - 会话ID
 * @param {string} summary - 进度摘要
 * @returns {Promise<void>}
 */
sendProgress(sessionId: string, summary: string): Promise<void>
```

---

## 8. FeishuSender 接口

### sendMessage(userId, content)
```javascript
/**
 * 发送文本消息
 * @param {string} userId - 用户ID
 * @param {string} content - 消息内容
 * @returns {Promise<void>}
 */
sendMessage(userId: string, content: string): Promise<void>
```

### sendCard(userId, card)
```javascript
/**
 * 发送富文本卡片
 * @param {string} userId - 用户ID
 * @param {Object} card - 卡片内容
 * @returns {Promise<void>}
 */
sendCard(userId: string, card: Object): Promise<void>
```

### sendProgress(userId, summary)
```javascript
/**
 * 发送进度摘要
 * @param {string} userId - 用户ID
 * @param {string} summary - 进度摘要
 * @returns {Promise<void>}
 */
sendProgress(userId: string, summary: string): Promise<void>
```

### sendResult(userId, result)
```javascript
/**
 * 发送最终结果
 * @param {string} userId - 用户ID
 * @param {Object} result - 执行结果
 * @returns {Promise<void>}
 */
sendResult(userId: string, result: {
  status: 'success' | 'error',
  summary: string,
  details: string,
  loopCount: number
}): Promise<void>
```