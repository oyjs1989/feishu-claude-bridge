# 飞书 iFlow 桥接服务 - 系统架构设计

## 1. 项目概述

### 1.1 项目目标
构建一个 Node.js 常驻服务,通过飞书 Hubble WebSocket 长连接接收消息,调用 iFlow CLI 执行任务,并将结果返回给飞书用户。

### 1.2 核心特性
- **飞书 Hubble WebSocket 长连接**: 实时双向通信
- **YOLO 模式执行**: 自动执行,无需用户确认
- **Superpowers 集成**: 默认启用 superpowers 技能
- **智能循环**: 自动识别 NEXT_PHASE 并继续执行
- **进度汇报**: 长时间任务每3分钟输出进度摘要
- **无数据库设计**: 全部使用 .md 文件存储数据

### 1.3 技术栈
- **语言**: Node.js (JavaScript/TypeScript)
- **飞书 SDK**: 飞书开放平台 SDK
- **iFlow CLI**: 通过 superpowers 技能调用
- **数据存储**: Markdown 文件

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        飞书平台                                    │
│                    (Hubble WebSocket)                            │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                   飞书 iFlow 桥接服务                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │WebSocket    │  │  事件处理器   │  │ 消息路由器   │          │
│  │连接管理器    │◄─┤              │◄─┤              │          │
│  └──────────────┘  └──────┬───────┘  └──────┬───────┘          │
│                            │                    │                   │
│                            ▼                    ▼                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 结果分析器   │  │ 会话上下文   │  │ 进度定时器   │          │
│  │              │◄─┤ 管理器(.md)  │  │ (3分钟间隔)  │          │
│  └──────┬───────┘  └──────────────┘  └──────┬───────┘          │
│         │                                  │                   │
│         ▼                                  ▼                   │
│  ┌──────────────┐  ┌──────────────────────────────────┐   │
│  │ Superpowers  │  │      iFlow CLI 适配器            │   │
│  │ 技能调用      │◄─┤      (YOLO 模式)                  │   │
│  └──────┬───────┘  └──────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 结果处理器   │  │ 飞书消息发送 │  │ 会话持久化   │          │
│  │              │  │              │  │ (.md文件)    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 WebSocket 连接管理器
- 职责: 与飞书服务器建立和维护 Hubble WebSocket 连接
- 功能:
  - 建立 WebSocket 连接
  - 心跳保持
  - 断线重连
  - 消息接收

#### 2.2.2 事件处理器
- 职责: 处理飞书事件
- 功能:
  - 解析飞书消息
  - 提取用户指令
  - 触发后续处理流程

#### 2.2.3 消息路由器
- 职责: 根据消息类型路由到相应处理器
- 功能:
  - 识别消息类型(文本/卡片等)
  - 路由到对应的处理逻辑

#### 2.2.4 结果分析器
- 职责: 分析 iFlow CLI 执行结果
- 功能:
  - 识别执行状态(成功/失败/需要确认/可以继续)
  - 提取 NEXT_PHASE 标记
  - 生成结果摘要

#### 2.2.5 会话上下文管理器
- 职责: 管理会话状态和上下文
- 功能:
  - 保存会话状态到 .md 文件
  - 恢复会话状态
  - 支持断点续传

#### 2.2.6 Superpowers 技能调用器
- 职责: 调用 superpowers 技能执行 iFlow CLI
- 功能:
  - 封装 superpowers 调用
  - 传递 YOLO 模式参数
  - 处理调用结果

#### 2.2.7 进度定时器
- 职责: 定时输出进度摘要
- 功能:
  - 每3分钟检查执行状态
  - 生成进度摘要
  - 发送到飞书

#### 2.2.8 结果处理器
- 职责: 处理和格式化执行结果
- 功能:
  - 提取关键信息
  - 生成友好的结果摘要
  - 发送到飞书

## 3. 数据流设计

### 3.1 消息处理流程

```
用户消息 → 飞书 → WebSocket 接收 → 事件处理器
                                         ↓
                                  消息路由器
                                         ↓
                                  创建/恢复会话
                                         ↓
                                  Superpowers 调用 (YOLO模式)
                                         ↓
                                  iFlow CLI 执行
                                         ↓
                                  结果分析器
                                         ↓
                              ┌─────────────┴─────────────┐
                              │                           │
                        【检测到NEXT_PHASE】          【无NEXT_PHASE】
                              │                           │
                              ↓                           ↓
                        更新会话状态               生成最终摘要
                              ↓                           ↓
                        Superpowers 调用             发送到飞书
                              ↓
                        (循环执行)
```

### 3.2 循环执行流程

```
iFlow CLI 执行 → 结果分析器
                      ↓
              ┌─────────────────┴─────────────────┐
              │                                   │
      【有 NEXT_PHASE】                   【无 NEXT_PHASE】
              │                                   │
              ↓                                   ↓
      提取 NEXT_PHASE                   生成最终摘要
              ↓                                   ↓
      更新会话状态                       发送到飞书
              ↓
      Superpowers 调用
              ↓
      (循环执行)
```

### 3.3 进度汇报流程

```
执行开始 → 启动进度定时器(3分钟)
              ↓
        ┌─────┴─────┐
        │           │
    执行循环    定时器触发
        │           │
        └─────┬─────┘
              ↓
        检查执行状态
              ↓
        生成进度摘要
              ↓
        发送到飞书
              ↓
        (继续执行)
```

## 4. 配置设计

### 4.1 环境变量配置

```env
# 飞书配置
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret
FEISHU_ENCRYPT_KEY=your_encrypt_key
FEISHU_VERIFICATION_TOKEN=your_token

# iFlow 配置
IFLOW_CLI_PATH=/usr/local/bin/iflow
SUPERPOWERS_ENABLED=true
SUPERPOWERS_MODE=yolo

# 执行配置
YOLO_MODE=true
AUTO_CONFIRM=true
MAX_LOOP_DEPTH=100
TIMEOUT_PER_STEP=300s

# 进度汇报配置
PROGRESS_INTERVAL=180s  # 3分钟
PROGRESS_ENABLED=true

# 会话配置
SESSION_TIMEOUT=3600s  # 1小时
SESSION_DIR=./data/sessions

# 日志配置
LOG_LEVEL=info
LOG_DIR=./logs
```

### 4.2 配置文件结构

```javascript
// config/default.js
module.exports = {
  feishu: {
    appId: process.env.FEISHU_APP_ID,
    appSecret: process.env.FEISHU_APP_SECRET,
    encryptKey: process.env.FEISHU_ENCRYPT_KEY,
    verificationToken: process.env.FEISHU_VERIFICATION_TOKEN,
    hubbleUrl: 'wss://open.feishu.cn/open-apis/hubble-im/v1'
  },
  iflow: {
    cliPath: process.env.IFLOW_CLI_PATH || 'iflow',
    superpowersEnabled: process.env.SUPERPOWERS_ENABLED !== 'false',
    superpowersMode: process.env.SUPERPOWERS_MODE || 'yolo'
  },
  execution: {
    yoloMode: process.env.YOLO_MODE !== 'false',
    autoConfirm: process.env.AUTO_CONFIRM !== 'false',
    maxLoopDepth: parseInt(process.env.MAX_LOOP_DEPTH || '100'),
    timeoutPerStep: parseInt(process.env.TIMEOUT_PER_STEP || '300')
  },
  progress: {
    interval: parseInt(process.env.PROGRESS_INTERVAL || '180'),
    enabled: process.env.PROGRESS_ENABLED !== 'false'
  },
  session: {
    timeout: parseInt(process.env.SESSION_TIMEOUT || '3600'),
    dir: process.env.SESSION_DIR || './data/sessions'
  },
  logging: {
    level: process.env.LOG_LEVEL || 'info',
    dir: process.env.LOG_DIR || './logs'
  }
};
```

## 5. 数据存储设计

### 5.1 会话数据结构

```markdown
# 会话ID: {sessionId}

## 元数据
- 用户ID: {userId}
- 创建时间: {createdAt}
- 更新时间: {updatedAt}
- 状态: {status} (running/completed/failed/timeout)

## 原始消息
- 消息ID: {messageId}
- 消息内容: {messageContent}
- 发送时间: {sendTime}

## 执行历史
### 第1次执行
- 指令: {command}
- 开始时间: {startTime}
- 结束时间: {endTime}
- 执行结果: {result}
- NEXT_PHASE: {nextPhase}

### 第2次执行
- 指令: {command}
- 开始时间: {startTime}
- 结束时间: {endTime}
- 执行结果: {result}
- NEXT_PHASE: {nextPhase}

...

## 当前状态
- 循环次数: {loopCount}
- 当前NEXT_PHASE: {currentNextPhase}
- 已执行时长: {elapsedTime}

## 最终结果
- 状态: {finalStatus}
- 结果摘要: {summary}
- 错误信息: {error}
```

### 5.2 文件组织结构

```
data/sessions/
├── {userId}/
│   ├── {sessionId}.md
│   ├── {sessionId}.md
│   └── ...
└── logs/
    └── {date}.md
```

## 6. iFlow CLI 集成规范

### 6.1 调用方式

```javascript
// 通过 superpowers 技能调用
const superpowers = require('./services/superpowers');

const result = await superpowers.execute({
  command: 'iflow',
  args: userMessage,
  mode: 'yolo',
  context: sessionContext,
  timeout: config.execution.timeoutPerStep * 1000
});
```

### 6.2 返回格式约定

```javascript
{
  success: true,
  output: "执行结果内容...",
  nextPhase: "下一阶段目标",  // 可选,如果需要继续执行
  error: null,
  metadata: {
    executionTime: 1234,
    command: "原始指令"
  }
}
```

### 6.3 NEXT_PHASE 标记

iFlow CLI 需要在输出中包含 NEXT_PHASE 标记,格式如下:

```
执行结果...

NEXT_PHASE: 实现用户登录功能
```

## 7. 进度汇报设计

### 7.1 进度摘要格式

```markdown
⏱️ 执行进度报告

📊 基本信息
- 当前阶段: {currentPhase}
- 已执行时长: {elapsedTime}
- 循环次数: {loopCount}

🎯 下一阶段
{nextPhase}

📈 执行状态
- 状态: {status}
- 最后输出: {lastOutput}

⏰ 预计完成
{estimatedTime}

---
会话ID: {sessionId}
```

### 7.2 触发条件

1. 执行时间超过3分钟
2. 处于循环执行状态
3. 有 NEXT_PHASE 存在

### 7.3 停止条件

1. 执行完成(无 NEXT_PHASE)
2. 执行失败
3. 用户手动终止
4. 达到最大循环深度
5. 会话超时

## 8. 安全设计

### 8.1 飞书事件验证
- 验证事件签名
- 验证时间戳(防重放)
- 白名单用户验证

### 8.2 命令安全
- 命令白名单
- 参数过滤
- 执行超时限制

### 8.3 资源限制
- 最大并发会话数
- 单会话最大执行时长
- 循环深度限制

## 9. 异常处理

### 9.1 网络异常
- WebSocket 断线重连
- 超时重试机制
- 降级处理

### 9.2 执行异常
- 捕获执行错误
- 记录详细日志
- 返回友好的错误信息

### 9.3 资源异常
- 内存溢出处理
- 磁盘空间检查
- 文件锁定处理

## 10. 监控和日志

### 10.1 日志级别
- ERROR: 错误信息
- WARN: 警告信息
- INFO: 一般信息
- DEBUG: 调试信息

### 10.2 日志内容
- 用户操作日志
- 执行日志
- 错误日志
- 性能日志

### 10.3 监控指标
- 在线用户数
- 执行任务数
- 成功率
- 平均响应时间
- 错误率