# 数据存储设计文档

## 概述

本系统不使用数据库,所有数据通过 `.md` 文件存储,确保数据可读性和可维护性。

---

## 1. 会话存储

### 存储位置
- 目录: `data/sessions/`
- 文件命名: `{sessionId}.md`
- 文件结构: Markdown 格式

### 会话文件格式

```markdown
# 会话: {sessionId}

## 基本信息

- 会话ID: `{sessionId}`
- 用户ID: `{userId}`
- 用户名: `{userName}`
- OpenID: `{openId}`
- 创建时间: `{createdAt}`
- 更新时间: `{updatedAt}`
- 循环次数: `{loopCount}`
- 执行状态: `{status}`

## 执行历史

### 第 1 轮

**时间**: `{timestamp}`

**输入命令**:
```
{command}
```

**执行输出**:
```
{output}
```

**状态**: `{status}`

**下一阶段**: `{nextPhase}`

### 第 2 轮

**时间**: `{timestamp}`

**输入命令**:
```
{command}
```

**执行输出**:
```
{output}
```

**状态**: `{status}`

**下一阶段**: `{nextPhase}`

...

## 会话摘要

- 总执行时长: `{totalDuration}`
- 成功轮次: `{successCount}`
- 失败轮次: `{failureCount}`
- 最终状态: `{finalStatus}`
```

### 会话状态值

- `idle` - 空闲
- `running` - 执行中
- `completed` - 已完成
- `error` - 错误
- `timeout` - 超时

---

## 2. 日志存储

### 存储位置
- 目录: `logs/`
- 文件命名: `{date}.log`
- 格式: 文本日志格式

### 日志格式

```
[2026-01-31 10:30:00] [INFO] 服务启动
[2026-01-31 10:30:05] [INFO] WebSocket 连接成功
[2026-01-31 10:31:00] [INFO] 收到用户消息: user_123 - "创建一个React应用"
[2026-01-31 10:31:01] [INFO] 创建新会话: session_abc123
[2026-31-31 10:31:02] [INFO] 执行命令: iflow create React app
[2026-01-31 10:31:30] [INFO] 执行完成, 检测到 NEXT_PHASE: 安装依赖
[2026-01-31 10:31:31] [INFO] 继续执行第 2 轮
...
```

### 日志级别

- `DEBUG` - 调试信息
- `INFO` - 一般信息
- `WARN` - 警告信息
- `ERROR` - 错误信息

---

## 3. 配置存储

### 存储位置
- 目录: `config/`
- 文件:
  - `default.js` - 默认配置
  - `production.js` - 生产环境配置
  - `development.js` - 开发环境配置

### 配置加载优先级

1. 环境变量
2. `config/{environment}.js`
3. `config/default.js`

---

## 4. 数据管理原则

### 文件命名规范

- 会话文件: `{sessionId}.md`
- 日志文件: `{YYYY-MM-DD}.log`
- 配置文件: `{name}.js`

### 文件清理策略

- 会话文件:
  - 执行完成的会话保留 7 天
  - 执行失败的会话保留 30 天
  - 自动清理过期文件

- 日志文件:
  - 日志文件保留 30 天
  - 自动压缩 7 天前的日志

### 数据备份

- 每日凌晨自动备份 `data/` 目录
- 备份文件保留 30 天

---

## 5. 数据完整性保证

### 文件锁机制

- 写入文件时使用独占锁
- 防止并发写入冲突

### 原子写入

- 先写入临时文件
- 写入完成后重命名
- 确保数据一致性

### 错误恢复

- 定期检查文件完整性
- 损坏的会话文件自动标记为 `error`
- 可手动修复损坏的文件

---

## 6. 数据访问接口

### SessionManager 数据访问

```javascript
// 创建会话文件
async createSession(userInfo) {
  const sessionId = generateSessionId();
  const session = {
    sessionId,
    userId: userInfo.userId,
    userName: userInfo.userName,
    openId: userInfo.openId,
    createdAt: new Date(),
    updatedAt: new Date(),
    loopCount: 0,
    status: 'idle',
    history: []
  };
  
  const filePath = path.join(this.config.sessionDir, `${sessionId}.md`);
  await this.saveToFile(filePath, this.formatSession(session));
  return session;
}

// 格式化会话为 Markdown
formatSession(session) {
  let md = `# 会话: ${session.sessionId}\n\n`;
  md += `## 基本信息\n\n`;
  md += `- 会话ID: \`${session.sessionId}\`\n`;
  md += `- 用户ID: \`${session.userId}\`\n`;
  // ... 更多字段
  
  md += `\n## 执行历史\n\n`;
  session.history.forEach((item, index) => {
    md += `### 第 ${index + 1} 轮\n\n`;
    md += `**时间**: \`${item.timestamp}\`\n\n`;
    md += `**输入命令**:\n\`\`\`\n${item.command}\n\`\`\`\n\n`;
    // ... 更多字段
  });
  
  return md;
}
```

### 日志写入接口

```javascript
// 写入日志
async writeLog(level, message) {
  const date = new Date().toISOString().split('T')[0];
  const logPath = path.join(this.config.logDir, `${date}.log`);
  const timestamp = new Date().toISOString();
  const logLine = `[${timestamp}] [${level}] ${message}\n`;
  
  await fs.appendFile(logPath, logLine, 'utf8');
}
```

---

## 7. 性能优化

### 文件缓存

- 会话文件在内存中缓存
- 只在更新时写入磁盘
- 定期刷新缓存到磁盘

### 批量写入

- 批量更新会话时使用单一写入
- 减少磁盘 I/O 操作

### 异步写入

- 所有文件操作使用异步 API
- 不阻塞主流程

---

## 8. 数据迁移

### 版本管理

- 在会话文件头部添加版本号
- 支持向后兼容

### 迁移策略

```markdown
# 会话: abc123

**版本**: 2.0

## 基本信息
...
```

### 自动迁移

- 服务启动时检查文件版本
- 自动迁移旧格式到新格式