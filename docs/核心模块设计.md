# 核心模块设计文档

## 1. WebSocket 连接管理器 (WebSocketManager)

**文件位置**: `src/core/WebSocketManager.js`

**职责**:
- 建立和维护与飞书服务器的 Hubble WebSocket 连接
- 处理心跳、重连机制
- 接收并解析飞书事件

**核心方法**:
- `connect()` - 建立 WebSocket 连接
- `disconnect()` - 断开连接
- `on(event, callback)` - 注册事件监听器
- `reconnect()` - 重连机制
- `send(data)` - 发送数据到飞书

**事件类型**:
- `message` - 收到飞书消息
- `connected` - 连接成功
- `disconnected` - 连接断开
- `error` - 连接错误

---

## 2. 事件处理器 (EventHandler)

**文件位置**: `src/handlers/EventHandler.js`

**职责**:
- 接收并解析飞书事件
- 提取消息内容和用户信息
- 路由到消息处理器

**核心方法**:
- `handle(event)` - 处理飞书事件
- `parseMessage(event)` - 解析消息内容
- `extractUserInfo(event)` - 提取用户信息
- `route(message, userInfo)` - 路由到消息处理器

**支持的事件类型**:
- `message` - 消息事件
- `im.message.receive_v1` - 单聊消息
- `group_at_message` - 群@消息

---

## 3. 消息路由器 (MessageRouter)

**文件位置**: `src/core/MessageRouter.js`

**职责**:
- 根据消息类型和会话状态决定处理方式
- 管理消息队列
- 处理并发请求

**核心方法**:
- `route(message, userInfo)` - 路由消息
- `handleNewSession(message, userInfo)` - 处理新会话
- `handleExistingSession(message, userInfo)` - 处理已有会话
- `getQueueStatus()` - 获取队列状态

---

## 4. iFlow CLI 适配器 (IFlowAdapter)

**文件位置**: `src/services/IFlowAdapter.js`

**职责**:
- 封装 iFlow CLI 的调用
- 集成 superpowers 技能
- 管理执行上下文

**核心方法**:
- `execute(command, options)` - 执行 iFlow 命令
- `executeWithSuperpowers(command, options)` - 通过 superpowers 执行
- `parseOutput(output)` - 解析执行输出
- `extractNextPhase(output)` - 提取 NEXT_PHASE

**配置参数**:
```javascript
{
  yoloMode: true,
  autoConfirm: true,
  timeout: 300,
  superpowersEnabled: true,
  superpowersMode: 'yolo'
}
```

---

## 5. 结果分析器 (ResultAnalyzer)

**文件位置**: `src/core/ResultAnalyzer.js`

**职责**:
- 分析 iFlow CLI 执行结果
- 识别执行状态
- 提取 NEXT_PHASE

**核心方法**:
- `analyze(output)` - 分析执行结果
- `extractNextPhase(output)` - 提取下一阶段目标
- `generateSummary(output, session)` - 生成执行摘要
- `shouldContinue(output)` - 判断是否应该继续

**返回状态**:
```javascript
{
  status: 'continue' | 'complete' | 'error',
  nextPhase: string | null,
  summary: string,
  error: string | null
}
```

---

## 6. 会话管理器 (SessionManager)

**文件位置**: `src/services/SessionManager.js`

**职责**:
- 管理会话生命周期
- 保存和恢复会话状态
- 使用 .md 文件存储会话数据

**核心方法**:
- `createSession(userInfo)` - 创建新会话
- `getSession(sessionId)` - 获取会话
- `updateSession(sessionId, data)` - 更新会话
- `saveSession(sessionId)` - 保存会话到 .md 文件
- `loadSession(sessionId)` - 从 .md 文件加载会话
- `deleteSession(sessionId)` - 删除会话

**会话数据结构**:
```markdown
# 会话: {sessionId}

- 用户ID: {userId}
- 用户名: {userName}
- 创建时间: {createdAt}
- 更新时间: {updatedAt}
- 循环次数: {loopCount}
- 执行状态: {status}

## 执行历史

### 第 1 轮
- 命令: {command}
- 输出: {output}
- 状态: {status}
- 时间: {timestamp}

### 第 2 轮
...
```

---

## 7. 进度管理器 (ProgressManager)

**文件位置**: `src/services/ProgressManager.js`

**职责**:
- 定时生成进度摘要
- 发送进度到飞书
- 管理进度定时器

**核心方法**:
- `start(sessionId)` - 启动进度监控
- `stop(sessionId)` - 停止进度监控
- `generateProgress(session)` - 生成进度摘要
- `sendProgress(sessionId, summary)` - 发送进度到飞书

**进度摘要格式**:
```
⏱️ 执行进度报告

当前阶段: {currentPhase}
已执行时长: {duration}
循环次数: {loopCount}
下一阶段: {nextPhase}
状态: {status}
```

---

## 8. 飞书消息发送器 (FeishuSender)

**文件位置**: `src/services/FeishuSender.js`

**职责**:
- 发送消息到飞书
- 发送进度摘要
- 发送最终结果

**核心方法**:
- `sendMessage(userId, content)` - 发送文本消息
- `sendCard(userId, card)` - 发送富文本卡片
- `sendProgress(userId, summary)` - 发送进度摘要
- `sendResult(userId, result)` - 发送最终结果

---

## 9. 主程序 (index.js)

**文件位置**: `src/index.js`

**职责**:
- 初始化所有组件
- 启动 WebSocket 服务
- 处理程序退出

**启动流程**:
1. 加载配置
2. 初始化日志
3. 创建 WebSocket 连接
4. 注册事件处理器
5. 启动服务

---

## 模块依赖关系

```
index.js
├── WebSocketManager
│   └── EventHandler
│       └── MessageRouter
│           ├── SessionManager
│           ├── IFlowAdapter
│           │   └── ResultAnalyzer
│           ├── ProgressManager
│           └── FeishuSender
└── Config (配置文件)
```

---

## 数据流

```
飞书消息
  ↓
WebSocketManager (接收)
  ↓
EventHandler (解析)
  ↓
MessageRouter (路由)
  ↓
SessionManager (创建/获取会话)
  ↓
IFlowAdapter (执行)
  ↓
ResultAnalyzer (分析)
  ↓
ProgressManager (进度汇报)
  ↓
FeishuSender (发送结果)
  ↓
飞书 (用户收到)
```